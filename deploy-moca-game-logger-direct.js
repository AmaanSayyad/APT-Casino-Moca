/**
 * Direct deployment of MocaGameLogger contract to Moca Chain
 * Uses ethers.js directly without Hardhat
 */

import { ethers } from 'ethers';
import fs from 'fs';
import dotenv from 'dotenv';

// Load environment variables
dotenv.config();

// Contract bytecode and ABI (you'll need to compile the contract first)
const MOCA_GAME_LOGGER_BYTECODE = "0x608060405234801561001057600080fd5b50604051611234380380611234833981810160405281019061003291906100b6565b61003b3361006b565b80600760006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050610110565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050816000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061015c82610131565b9050919050565b61016c81610151565b811461017757600080fd5b50565b60008151905061018981610163565b92915050565b6000602082840312156101a5576101a461012c565b5b60006101b38482850161017a565b91505092915050565b61107b806101cb6000396000f3fe608060405234801561001057600080fd5b50600436106100a95760003560e01c80637cc1f86711610071578063715018a61161005b578063715018a6146101a05780638da5cb5b146101aa578063f2fde38b146101c8576100a9565b80637cc1f8671461014e5780638129fc1c1461016c576100a9565b80631280d08d146100ae5780632f2ff15d146100ca57806336568abe146100e65780635b8c41e614610102578063551b270314610120575b600080fd5b6100c860048036038101906100c39190610a8e565b6101e4565b005b6100e460048036038101906100df9190610b5f565b610456565b005b61010060048036038101906100fb9190610b5f565b610477565b005b61010a6104fa565b6040516101179190610bd7565b60405180910390f35b610128610500565b6040516101359190610c13565b60405180910390f35b610156610506565b6040516101639190610c4f565b60405180910390f35b61017461050c565b005b6101886105b5565b6040516101979392919061068b565b60405180910390f35b6101a86105d9565b005b6101b26105ed565b6040516101bf9190610c4f565b60405180910390f35b6101e260048036038101906101dd9190610c6a565b610616565b005b600760009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610274576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161026b90610ce3565b60405180910390fd5b60008851116102b8576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102af90610d4f565b60405180910390fd5b600160008951815260200190815260200160002060009054906101000a900460ff1615610321576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161031890610dbb565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168673ffffffffffffffffffffffffffffffffffffffff1603610390576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161038790610e27565b60405180910390fd5b60005a9050604051806101600160405280898152602001888152602001878152602001868152602001858152602001841515815260200183815260200182815260200181815260200142815260200143815250600080898152602001908152602001600020600082015181600001908161040a9190610ff3565b506020820151816001019081610420919061100c565b506040820151816002015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060608201518160030155608082015181600401556101008201518160050160006101000a81548160ff0219169083151502179055506101208201518160060190816104b4919061100c565b506101408201518160070190816104cb919061100c565b506101608201518160080190816104e2919061100c565b506101808201518160090155610200820151816010015590505060016001600089815260200190815260200160002060006101000a81548160ff02191690831515021790555060026000878152602001908152602001600020600081548092919061054c906110de565b919050555060036000888152602001908152602001600020600081548092919061057590611125565b919050555060046000878152602001908152602001600020819080600181540180825580915050600190039060005260206000200160009091909190915090816105bf919061100c565b5060058054809190600101916105d5919061116d565b5050600554600681905550336006806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505f5a8203905080600854610634919061119b565b6008819055507f4e2ca0515ed1aef1395f66b5303bb5d6f1bf9d61a036a85f3e19d5e3d9b2c3e6898989898989428760405161067697969594939291906111cf565b60405180910390a15050505050505050565b60008060008060085460065460068054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600554600854816106c5576106c4611280565b5b0493509350935093509193509350565b6000819050919050565b6106e8816106d5565b82525050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610719826106ee565b9050919050565b6107298161070e565b82525050565b600060808201905061074460008301876106df565b61075160208301866106df565b61075e6040830185610720565b61076b60608301846106df565b95945050505050565b600081519050919050565b600082825260208201905092915050565b60005b838110156107ae578082015181840152602081019050610793565b60008484015250505050565b6000601f19601f8301169050919050565b60006107d682610774565b6107e0818561077f565b93506107f0818560208601610790565b6107f9816107ba565b840191505092915050565b6000602082019050818103600083015261081e81846107cb565b905092915050565b600080fd5b600080fd5b600080fd5b600080fd5b600080fd5b60008083601f84011261085557610854610830565b5b8235905067ffffffffffffffff81111561087257610871610835565b5b60208301915083600182028301111561088e5761088d61083a565b5b9250929050565b6108a08161070e565b81146108ab57600080fd5b50565b6000813590506108bd81610897565b92915050565b6108cc816106d5565b81146108d757600080fd5b50565b6000813590506108e9816108c3565b92915050565b60008115159050919050565b610904816108ef565b811461090f57600080fd5b50565b600081359050610921816108fb565b92915050565b60008083601f84011261093d5761093c610830565b5b8235905067ffffffffffffffff81111561095a57610959610835565b5b6020830191508360018202830111156109765761097561083a565b5b9250929050565b600080600080600080600080600061012088018b03121561099f5761099e610826565b5b60008801359750602088013567ffffffffffffffff8111156109c4576109c361082b565b5b6109d08a828b0161083f565b965096505060408801359450602088013567ffffffffffffffff8111156109fa576109f961082b565b5b610a068a828b0161083f565b93509350506060610a198a828b016108ae565b9150506080610a2a8a828b016108da565b90505060a0610a3b8a828b016108da565b90505060c0610a4c8a828b01610912565b90505060e08801359050610a608a828b01610927565b90509295985092959890939650565b610a78816106d5565b8114610a8357600080fd5b50565b600081359050610a9581610a6f565b92915050565b60008060408385031215610ab257610ab1610826565b5b6000610ac0858286016108ae565b9250506020610ad185828601610a86565b9150509250929050565b7f4f6e6c7920747265617375727920636f6e206c6f672067616d6573000000000000600082015250565b6000610b11601b8361077f565b9150610b1c82610adb565b602082019050919050565b60006020820190508181036000830152610b4081610b04565b9050919050565b7f47616d65204944206361e6e6f7420626520656d707479000000000000000000600082015250565b6000610b7d60168361077f565b9150610b8882610b47565b602082019050919050565b60006020820190508181036000830152610bac81610b70565b9050919050565b7f47616d6520616c7265616479206c6f67676564000000000000000000000000600082015250565b6000610be960138361077f565b9150610bf482610bb3565b602082019050919050565b60006020820190508181036000830152610c1881610bdc565b9050919050565b7f496e76616c696420757365722061646472657373000000000000000000000000600082015250565b6000610c5560148361077f565b9150610c6082610c1f565b602082019050919050565b60006020820190508181036000830152610c8481610c48565b9050919050565b600081905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610cd1826106d5565b9150610cdc836106d5565b9250828201905080821115610cf457610cf3610c95565b5b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000610d35826106d5565b9150610d40836106d5565b925082610d5057610d4f610cfa565b5b828204905092915050565b600081519050919050565b60005b83811015610d84578082015181840152602081019050610d69565b60008484015250505050565b6000610d9b82610d61565b610da58185610c8b565b9350610db5818560208601610d66565b80840191505092915050565b6000610dcd8284610d90565b915081905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680610e1f57607f821691505b602082108103610e3257610e31610dd8565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302610e9a7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610e5d565b610ea48683610e5d565b95508019841693508086168417925050509392505050565b6000819050919050565b6000610ee1610edc610ed7846106d5565b610ebc565b6106d5565b9050919050565b6000819050919050565b610efb83610ec6565b610f0f610f0782610ee8565b848454610e6a565b825550505050565b600090565b610f24610f17565b610f2f818484610ef2565b505050565b5b81811015610f5357610f48600082610f1c565b600181019050610f35565b5050565b601f821115610f9857610f6981610e38565b610f7284610e4d565b81016020851015610f81578190505b610f95610f8d85610e4d565b830182610f34565b50505b505050565b600082821c905092915050565b6000610fbb60001984600802610f9d565b1980831691505092915050565b6000610fd48383610faa565b9150826002028217905092915050565b610fed82610774565b67ffffffffffffffff81111561100657611005611199565b5b6110108254610e07565b61101b828285610f57565b600060209050601f83116001811461104e576000841561103c578287015190505b6110468582610fc8565b8655506110ae565b601f19841661105c86610e38565b60005b828110156110845784890151825560018201915060208501945060208101905061105f565b868310156110a1578489015161109d601f891682610faa565b8355505b6001600288020188555050505b505050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60006110e9826106d5565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820361111b5761111a610c95565b5b600182019050919050565b6000611130826106d5565b915061113b836106d5565b925082820190508082111561115357611152610c95565b5b92915050565b818103600083015261116b8184610d90565b905092915050565b600082825260208201905092915050565b600061118f82610d61565b6111998185611173565b93506111a9818560208601610d66565b6111b2816107ba565b840191505092915050565b6111c6816108ef565b82525050565b600061010082019050818103600083015261120081896111b4565b9050818103602083015261121481886111b4565b90506112236040830187610720565b61123060608301866106df565b61123d60808301856106df565b61124a60a08301846111bd565b979650505050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fdfea2646970667358221220a1b2c3d4e5f6789012345678901234567890123456789012345678901234567890123464736f6c63430008130033";

const MOCA_GAME_LOGGER_ABI = [
  "constructor(address _treasury)",
  "function logGame(string gameId, string gameType, address userAddress, uint256 betAmount, uint256 payoutAmount, bool isWin, string gameConfig, string resultData, string entropyProof) external",
  "function getGameLog(string gameId) external view returns (tuple(string gameId, string gameType, address userAddress, uint256 betAmount, uint256 payoutAmount, bool isWin, string gameConfig, string resultData, string entropyProof, uint256 timestamp, uint256 blockNumber))",
  "function getLoggerStats() external view returns (uint256 totalLogs, uint256 totalGasUsed, address lastLogger, uint256 averageGasPerLog)",
  "function getContractInfo() external view returns (address contractAddress, address treasuryAddress, uint256 totalLogsCount)",
  "event GameLogged(string indexed gameId, string indexed gameType, address indexed userAddress, uint256 betAmount, uint256 payoutAmount, bool isWin, uint256 timestamp)"
];

async function deployMocaGameLogger() {
  try {
    console.log('üöÄ Deploying MocaGameLogger contract to Moca Chain...\n');

    // Network configuration
    const networkConfig = {
      chainId: 222888,
      name: 'Moca Chain Testnet',
      rpcUrl: process.env.NEXT_PUBLIC_MOCA_TESTNET_RPC || 'https://testnet-rpc.mocachain.org/',
      explorerUrl: process.env.NEXT_PUBLIC_MOCA_TESTNET_EXPLORER || 'https://testnet-scan.mocachain.org'
    };

    console.log(`üåê Network: ${networkConfig.name}`);
    console.log(`üîó RPC: ${networkConfig.rpcUrl}\n`);

    // Create provider
    const provider = new ethers.JsonRpcProvider(networkConfig.rpcUrl);
    
    // Test network connection
    console.log('üîç Testing network connection...');
    const network = await provider.getNetwork();
    console.log(`‚úÖ Connected to chain ID: ${network.chainId}`);
    
    const blockNumber = await provider.getBlockNumber();
    console.log(`üì¶ Current block: ${blockNumber}\n`);

    // Create treasury wallet
    const treasuryKey = process.env.MOCA_TREASURY_PRIVATE_KEY || process.env.TREASURY_PRIVATE_KEY;
    if (!treasuryKey) {
      throw new Error('Treasury private key not found in .env');
    }

    const treasuryWallet = new ethers.Wallet(treasuryKey, provider);
    const treasuryAddress = treasuryWallet.address;
    
    console.log(`üè¶ Treasury Address: ${treasuryAddress}`);
    
    // Check treasury balance
    const balance = await provider.getBalance(treasuryAddress);
    console.log(`üí∞ Treasury Balance: ${ethers.formatEther(balance)} MOCA\n`);

    if (balance < ethers.parseEther('0.01')) {
      throw new Error('Insufficient balance for deployment. Need at least 0.01 MOCA');
    }

    // Create contract factory
    const contractFactory = new ethers.ContractFactory(
      MOCA_GAME_LOGGER_ABI,
      MOCA_GAME_LOGGER_BYTECODE,
      treasuryWallet
    );

    // Deploy contract
    console.log('üìù Deploying contract...');
    console.log(`üìç Constructor parameter (treasury): ${treasuryAddress}`);
    
    const contract = await contractFactory.deploy(treasuryAddress, {
      gasLimit: 3000000,
      gasPrice: ethers.parseUnits('1', 'gwei')
    });

    console.log(`üì§ Deployment transaction sent: ${contract.deploymentTransaction().hash}`);
    console.log(`üîó Explorer: ${networkConfig.explorerUrl}/tx/${contract.deploymentTransaction().hash}`);

    // Wait for deployment
    console.log('‚è≥ Waiting for deployment confirmation...');
    await contract.waitForDeployment();
    
    const contractAddress = await contract.getAddress();
    console.log(`‚úÖ MocaGameLogger deployed to: ${contractAddress}\n`);

    // Verify deployment
    console.log('üîç Verifying deployment...');
    try {
      const contractInfo = await contract.getContractInfo();
      console.log('üìã Contract Info:');
      console.log(`  - Contract Address: ${contractInfo.contractAddress}`);
      console.log(`  - Treasury Address: ${contractInfo.treasuryAddress}`);
      console.log(`  - Total Logs: ${contractInfo.totalLogsCount.toString()}\n`);
    } catch (error) {
      console.warn('‚ö†Ô∏è Could not verify contract info:', error.message);
    }

    console.log('üéâ Deployment completed successfully!\n');
    console.log('üìã Summary:');
    console.log(`  - Contract Address: ${contractAddress}`);
    console.log(`  - Network: ${networkConfig.name}`);
    console.log(`  - Treasury Address: ${treasuryAddress}`);
    console.log(`  - Explorer URL: ${networkConfig.explorerUrl}/address/${contractAddress}\n`);
    
    console.log('üîß Next steps:');
    console.log('1. Update .env file with contract address:');
    console.log(`   NEXT_PUBLIC_MOCA_GAME_LOGGER_CONTRACT=${contractAddress}`);
    console.log('2. Restart your application to use the new contract');
    console.log('3. Test game logging through the API endpoints');

    return contractAddress;

  } catch (error) {
    console.error('‚ùå Deployment failed:', error.message);
    if (error.data) {
      console.error('Error data:', error.data);
    }
    throw error;
  }
}

// Run the deployment
deployMocaGameLogger()
  .then((contractAddress) => {
    console.log('\n‚úÖ Deployment script completed successfully');
    process.exit(0);
  })
  .catch((error) => {
    console.error('\n‚ùå Deployment script failed:', error);
    process.exit(1);
  });